# حل مشكلة إنشاء الطلبات

هذا الملف يشرح المشكلة التي واجهتها في إنشاء الطلبات وآلية حلها.

## المشكلة

المشكلة الرئيسية كانت في:

1. عدم اتساق دالة `createOrder` مع هيكل قاعدة البيانات الفعلي
2. استخدام حقول غير موجودة في قاعدة البيانات (`status`، `total_amount`، `product_name`، إلخ)
3. عدم وضوح تدفق العمليات عند إنشاء الطلب

## الحل

تم إجراء التصحيحات التالية:

1. تعديل الواجهات (Interfaces) لتتوافق مع هيكل قاعدة البيانات الفعلي
2. تبسيط دالة `createOrder` لتنفذ:
   - إنشاء سجل في جدول `orders` أولاً مع `user_id` و `created_at` فقط
   - استخدام `id` الناتج لإنشاء عناصر الطلب في جدول `order_items`
3. إضافة `console.log` مفصل لتتبع كل خطوة
4. تحسين معالجة الأخطاء والتحقق من النتائج

## الأدوات المساعدة

قمنا بإنشاء مجموعة من الأدوات المساعدة للتحقق من المشكلة وتصحيحها:

### 1. اختبار إنشاء الطلب عبر API مباشرة

```
test-order-api.bat
```

يقوم هذا الاختبار بإنشاء طلب باستخدام مكتبة Supabase مباشرة، ويعرض كل خطوة من العملية مع رسائل تشخيص.

### 2. أداة تتبع إنشاء الطلبات في المتصفح

```
track-browser-orders.js
```

تنشئ هذه الأداة ملف JavaScript يمكن نسخه ولصقه في وحدة تحكم المتصفح (DevTools Console) لتتبع كل طلب شبكة يتم إرساله إلى Supabase أثناء عملية إنشاء الطلب، وتسجيل الاستجابات والأخطاء.

### 3. تصحيح سياسات RLS

```
fix-orders-rls.bat
fix-orders-rls.sql
```

تتأكد هذه الأدوات من صحة سياسات RLS على جداول الطلبات، وتصحح أي مشكلات تتعلق بالصلاحيات.

## الاستخدام

### 1. لاختبار إنشاء الطلبات مباشرة:

قم بتشغيل:

```
test-order-api.bat
```

ستظهر تفاصيل الاختبار وما إذا كان الطلب قد تم إنشاؤه بنجاح.

### 2. لتتبع طلبات إنشاء الطلب في المتصفح:

1. قم بتشغيل:
   ```
   node track-browser-orders.js
   ```

2. سيتم إنشاء ملف `browser-tracking-code.js`
3. انسخ محتوى الملف
4. افتح المتصفح وقم بتسجيل الدخول إلى التطبيق
5. افتح وحدة تحكم المطورين (DevTools) بالضغط على F12
6. الصق الكود في وحدة التحكم واضغط Enter
7. قم بإنشاء طلب من خلال واجهة المستخدم
8. راجع سجلات وحدة التحكم لمعرفة تفاصيل الطلبات والاستجابات

### 3. لإصلاح سياسات RLS:

قم بتشغيل:

```
fix-orders-rls.bat
```

## الملفات المصححة

1. `lib/orders.ts` - تم تحديث واجهات `Order` و `OrderItem` ودالة `createOrder`
2. `fix-orders-rls.sql` - سياسات RLS الصحيحة لجداول الطلبات

## أهم التغييرات

### 1. واجهة Order الجديدة

```typescript
export interface Order {
  id?: string;
  user_id: string;
  created_at?: string;
  items: OrderItem[];
}
```

### 2. واجهة OrderItem الجديدة

```typescript
export interface OrderItem {
  product_id: string;
  quantity: number;
  notes?: string;
  note?: string;  // الاسم المستخدم في قاعدة البيانات
  id?: string;
  order_id?: string;
  is_prepared?: boolean;
  created_at?: string;
}
```

### 3. تدفق إنشاء الطلب

الآن عملية إنشاء الطلب تتبع الخطوات التالية:

1. التحقق من تسجيل دخول المستخدم
2. إنشاء سجل في جدول `orders` مع `user_id` فقط
3. استخدام `id` الناتج لإنشاء عناصر الطلب في جدول `order_items`
4. التحقق من وجود الطلب وعناصره في قاعدة البيانات

## نصائح إضافية

1. استخدم دائماً `console.log` لتتبع الخطوات والبيانات في كل مرحلة
2. تأكد من اتساق بنية البيانات المرسلة مع هيكل قاعدة البيانات
3. لا تفترض وجود حقول لم تقم بإنشائها صراحةً في قاعدة البيانات
4. تعامل مع الأخطاء بشكل صحيح ولا تتجاهلها

## في حالة استمرار المشكلة

إذا استمرت المشكلة، حاول:

1. التحقق من سجلات الخادم (يمكنك الوصول إليها من لوحة تحكم Supabase)
2. التأكد من صحة سياسات RLS على جداول الطلبات وعناصر الطلبات
3. محاولة إنشاء طلب عبر واجهة SQL في Supabase مباشرة
4. تنقيح المشكلة باستخدام الأدوات المذكورة أعلاه 