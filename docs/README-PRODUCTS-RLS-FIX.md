# إصلاح مشكلة سياسات RLS لجدول المنتجات

## المشكلة

تظهر مشكلة عند محاولة إضافة منتجات جديدة بغض النظر عن حالة تفعيل سياسات RLS. هذه المشكلة تحدث عادةً بسبب:

1. سياسات RLS غير مكتملة أو متضاربة
2. نقص في الصلاحيات المناسبة للمستخدمين المصادق عليهم
3. مشكلة في تكوين السياسات الأمنية

## الحل

قمنا بإنشاء ثلاثة ملفات للتعامل مع هذه المشكلة:

1. `fix-products-rls.js`: سكريبت Node.js يقوم بإصلاح سياسات RLS تلقائياً
2. `fix-products-rls.bat`: ملف تشغيل لتنفيذ السكريبت بسهولة
3. `fix-products-rls.sql`: أوامر SQL لإصلاح المشكلة يدوياً إذا لزم الأمر

### الخيار 1: استخدام التصحيح التلقائي

هذا هو الحل الأسهل والموصى به:

1. قم بفتح موجه الأوامر (Command Prompt)
2. انتقل إلى مجلد المشروع
3. قم بتشغيل الملف `fix-products-rls.bat`

سيقوم السكريبت تلقائياً بما يلي:
- تسجيل الدخول كمستخدم مصادق عليه
- إلغاء تفعيل RLS مؤقتاً على جدول المنتجات
- حذف السياسات القديمة
- إعادة تفعيل RLS مع إضافة السياسات الصحيحة
- اختبار الوظائف للتأكد من نجاح الإصلاح

### الخيار 2: التصحيح اليدوي

إذا لم ينجح الخيار الأول، يمكنك اتباع هذه الخطوات:

1. قم بتسجيل الدخول إلى لوحة تحكم Supabase
2. انتقل إلى قسم "SQL Editor"
3. قم بنسخ محتوى ملف `fix-products-rls.sql`
4. الصق الأوامر في محرر SQL وقم بتنفيذها

## كيف يعمل الإصلاح؟

يعالج الإصلاح المشكلة من خلال:

1. **إلغاء تفعيل RLS مؤقتاً**: هذا يتيح الوصول الكامل لإجراء التغييرات
2. **إزالة السياسات المتضاربة**: حذف جميع السياسات الموجودة لتجنب التضارب
3. **إنشاء سياسات واضحة ومحددة**: تعريف سياسات لكل من:
   - القراءة (متاحة للجميع)
   - الإدراج/التحديث/الحذف (للمستخدمين المصادق عليهم فقط)
4. **منح الصلاحيات الصريحة**: التأكد من منح الصلاحيات المناسبة

## اختبار الحل

بعد تطبيق الإصلاح، يمكنك اختبار ما إذا كانت المشكلة قد تم حلها من خلال:

1. تسجيل الدخول إلى التطبيق
2. محاولة إضافة منتج جديد
3. التأكد من أن المنتج قد تم إضافته بنجاح

إذا استمرت المشكلة، يرجى التحقق من سجلات الأخطاء واتصال قاعدة البيانات.

## ملاحظات إضافية

- تأكد من تسجيل الدخول قبل محاولة إضافة أو تعديل المنتجات
- تتطلب سياسات RLS تسجيل الدخول حتى مع الصلاحيات الكاملة
- قد تحتاج إلى إعادة تشغيل التطبيق بعد تطبيق التغييرات 