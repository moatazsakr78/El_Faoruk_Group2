# إصلاح مشكلة حذف وتعديل الطلبات مع سياسات RLS

## المشكلة

عند تفعيل سياسات Row Level Security (RLS) على جداول الطلبات (`orders` و `order_items`)، تظهر المشاكل التالية:

1. **عدم القدرة على حذف الطلبات**: عند محاولة حذف طلب، يكون الحذف غير ناجح رغم وجود الكود اللازم للحذف.
2. **عدم القدرة على تعديل الطلبات**: لا تنعكس التعديلات على قاعدة البيانات.

السبب الرئيسي لهذه المشكلة هو وجود تضارب وتداخل في سياسات RLS المطبقة على الجداول، بالإضافة إلى عدم وجود سياسات صريحة للحذف.

## الحل

تم إنشاء ملف `fix-orders-rls.sql` يقوم بالإصلاحات التالية:

1. حذف جميع السياسات القديمة المتضاربة
2. إنشاء سياسات جديدة مبسطة وواضحة بأسماء موحدة
3. إضافة سياسات صريحة للحذف لكل من:
   - جدول الطلبات `orders`
   - جدول عناصر الطلبات `order_items`
4. منح الصلاحيات اللازمة للمستخدمين المصادق عليهم
5. إضافة فهارس لتحسين أداء الاستعلامات

## كيفية تطبيق الإصلاح

### الطريقة الأولى: استخدام ملف الباتش

هذه هي الطريقة الأسهل والموصى بها:

1. تأكد من تعيين المتغير البيئي `SUPABASE_SERVICE_KEY` أو إضافته في ملف `.env`
2. قم بتنفيذ ملف `apply-order-fixes.bat`

```bash
./apply-order-fixes.bat
```

### الطريقة الثانية: التنفيذ اليدوي في Supabase

1. افتح لوحة تحكم Supabase
2. انتقل إلى "SQL Editor"
3. قم بنسخ محتوى ملف `fix-orders-rls.sql` ولصقه
4. اضغط على زر "Run" لتنفيذ الاستعلام

## التحقق من نجاح الإصلاح

بعد تطبيق الإصلاح، قم بالخطوات التالية للتأكد من حل المشكلة:

1. قم بتسجيل الدخول إلى التطبيق
2. انتقل إلى صفحة الطلبات
3. حاول حذف أحد الطلبات - يجب أن يتم الحذف بنجاح
4. حاول تعديل أحد الطلبات - يجب أن تظهر التعديلات بشكل صحيح

## نظرة فنية على المشكلة

المشكلة تكمن في طريقة عمل سياسات RLS في Supabase. عند تفعيل RLS على جدول، يتم منع جميع العمليات (قراءة، إضافة، تعديل، حذف) افتراضياً. ويجب إضافة سياسات محددة لكل نوع من العمليات.

في التطبيق الأصلي، كانت هناك سياسات للقراءة والإضافة، ولكن لم تكن هناك سياسات صريحة للحذف والتعديل، أو كانت متداخلة ومتضاربة مع سياسات أخرى.

### التغييرات الرئيسية في السياسات

1. **توحيد أسماء السياسات**: استخدام أسماء إنجليزية قياسية مثل `orders_delete` بدلاً من الأسماء العربية الطويلة
2. **إزالة التداخل**: حذف جميع السياسات القديمة قبل إنشاء السياسات الجديدة
3. **تبسيط القواعد**: جعل قواعد السياسات أكثر وضوحاً ومباشرة
4. **صلاحيات واضحة**: منح صلاحيات صريحة لجميع العمليات للمستخدمين المصادق عليهم

## الخلاصة

بعد تطبيق هذه الإصلاحات، يجب أن تعمل جميع عمليات الطلبات (إضافة، قراءة، تعديل، حذف) بشكل صحيح حتى مع تفعيل سياسات RLS. إذا استمرت المشكلة، تأكد من تطبيق السياسات بشكل صحيح وتحقق من سجلات الخطأ في وحدة التحكم للحصول على مزيد من المعلومات. 