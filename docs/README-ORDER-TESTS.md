# أدوات اختبار الطلبات (Orders)

هذا الملف يشرح كيفية استخدام الأدوات المتوفرة لاختبار عملية إنشاء الطلبات والتحقق من وصولها إلى قاعدة البيانات.

## المشكلة

تواجه مشكلة في إنشاء الطلبات حيث لا تصل إلى قاعدة البيانات بشكل صحيح، أو قد تكون هناك مشكلات مع سياسات RLS.

## الأدوات المتوفرة

قمنا بإنشاء مجموعة من الأدوات المساعدة:

### 1. اختبار إنشاء الطلبات عبر API

يقوم هذا الاختبار بإنشاء طلب مباشرة عبر API مع قاعدة البيانات ويتتبع العملية خطوة بخطوة:

```
test-order-api.bat
```

**ما يقوم به:**
- تسجيل الدخول كمستخدم اختبار
- البحث عن منتجات للاختبار
- إنشاء طلب جديد مباشرة في قاعدة البيانات في خطوتين:
  1. إنشاء السجل الرئيسي في جدول `orders`
  2. إنشاء العناصر في جدول `order_items` باستخدام معرف الطلب
- التحقق من إنشاء الطلب بنجاح عبر استرجاعه من قاعدة البيانات
- عرض سجلات مفصلة مع طوابع زمنية

### 2. اختبار إنشاء الطلبات من خلال واجهة المستخدم

يقوم هذا الاختبار بمحاكاة إنشاء طلب من خلال واجهة المستخدم ومراقبة طلبات API في المتصفح:

```
test-order-browser.bat
```

**ما يقوم به:**
- فتح المتصفح تلقائياً
- تسجيل الدخول للتطبيق
- إضافة منتجات إلى السلة
- إنشاء طلب جديد
- تتبع طلبات الشبكة المرسلة إلى Supabase
- التقاط لقطات شاشة للنتائج
- عرض الاستجابات من Supabase

### 3. تصحيح سياسات RLS للطلبات

في حالة وجود مشكلات في سياسات RLS، يمكنك تطبيق السياسات الصحيحة باستخدام:

```
fix-orders-rls.bat
```

أو تنفيذ ملف SQL مباشرة في واجهة SQL في Supabase:

```
fix-orders-rls.sql
```

## كيفية الاستخدام

1. **للتحقق من مشكلة إنشاء الطلبات:**
   - قم بتشغيل `test-order-api.bat` أولاً لاختبار الاتصال المباشر بقاعدة البيانات
   - راقب السجلات للتحقق من أي أخطاء محددة

2. **للتحقق من المشكلة في واجهة المستخدم:**
   - قم بتشغيل `test-order-browser.bat` (قد تحتاج لتعديل عنوان URL في الملف أولاً)
   - راقب سجلات الشبكة والمتصفح لمعرفة المشكلة

3. **لإصلاح سياسات RLS:**
   - قم بتشغيل `fix-orders-rls.bat` إذا كانت المشكلة متعلقة بسياسات RLS

## ملاحظات هامة

- تأكد من إعداد بيانات الاعتماد الصحيحة في ملفات الاختبار (العنوان URL ومفتاح API)
- قد تحتاج إلى تعديل محددات CSS في ملف اختبار المتصفح لتتناسب مع هيكل تطبيقك
- يمكنك تعديل بيانات المستخدم الاختباري (البريد الإلكتروني وكلمة المرور) في الملفات حسب الحاجة

## المساهمة في حل المشكلة

إذا اكتشفت المشكلة بالضبط، يمكنك:

1. تعديل دالة `createOrder` في ملف `orders.ts` لمعالجة الخطأ المحدد
2. تعديل سياسات RLS من خلال ملف `fix-orders-rls.sql`
3. التحقق من الحل باستخدام أدوات الاختبار المتوفرة 