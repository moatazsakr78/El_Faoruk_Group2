# إصلاح مشكلة RLS مع الطلبات في Supabase

## المشكلة

عند محاولة إنشاء طلبات جديدة، لا تظهر في جدولي `orders` و `order_items` في قاعدة البيانات عندما تكون سياسات RLS مفعّلة. عند إيقاف سياسات RLS، يتم تخزين البيانات بشكل طبيعي.

السبب هو أن سياسات Row Level Security (RLS) في Supabase تمنع إدراج البيانات في جداول الطلبات دون وجود سياسات مناسبة.

## الحلول

### 1. تطبيق سياسات RLS المناسبة (الحل المفضل)

#### الطريقة المباشرة باستخدام واجهة Supabase SQL:

1. قم بتسجيل الدخول إلى لوحة تحكم Supabase
2. انتقل إلى قسم SQL في قائمة Database
3. قم بنسخ محتوى ملف `rls-policy-commands.sql` من مشروعك
4. ألصق جميع الأوامر في محرر SQL واضغط على Run
5. ستلاحظ رسائل نجاح لتطبيق جميع السياسات

هذه هي الطريقة الأكثر موثوقية لتطبيق السياسات.

#### الطريقة البديلة باستخدام السكريبت:

قمنا بإنشاء سكريبت خاص لتطبيق سياسات RLS المناسبة على جداول الطلبات:

1. قم بتشغيل ملف `apply-rls.bat` لتطبيق سياسات RLS المناسبة
2. سيقوم السكريبت بإنشاء السياسات التالية:
   - السماح للمستخدمين المسجلين بإنشاء الطلبات
   - السماح للمستخدمين بقراءة وتعديل طلباتهم فقط
   - السماح للمستخدمين بقراءة وتعديل عناصر طلباتهم فقط
   - إنشاء دالة مساعدة للتعامل مع إنشاء الطلبات

**هذا هو الحل المفضل لأنه يحافظ على أمان البيانات مع السماح بإنشاء الطلبات.**

### 2. استخدام الطريقة المحسنة لإنشاء الطلبات

إذا كنت تفضل استخدام الكود الحالي، يمكنك استخدام الدالة المحسنة `createOrderEnhanced` التي تجرب أولاً الطريقة المباشرة، وإذا فشلت، فستستخدم طريقة RPC الآمنة.

لاستخدام هذه الطريقة:

```javascript
// استخدم createOrderEnhanced بدلاً من createOrder
const { createOrderEnhanced } = require('./supabase-order-helper');

// ثم استخدم الدالة المحسنة
const result = await createOrderEnhanced(orderData, orderItems);
```

### 3. تشغيل سكريبت إصلاح RPC

للإصلاح السريع، يمكنك تشغيل سكريبت إصلاح RLS الذي ينشئ وظيفة RPC بدون تعديل سياسات RLS:

```
cd HeaWaBas
fix-rls.bat
```

## تفاصيل سياسات RLS المطبقة

السياسات المطبقة على جدول `orders`:

```sql
-- سياسة تتيح للمستخدمين المصادق عليهم إنشاء طلبات
CREATE POLICY "يمكن للمستخدمين المصادق عليهم إنشاء طلبات" ON public.orders
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- سياسة تتيح للمستخدمين قراءة طلباتهم فقط
CREATE POLICY "يمكن للمستخدمين قراءة طلباتهم فقط" ON public.orders
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);

-- سياسة تتيح للمستخدمين تعديل طلباتهم فقط
CREATE POLICY "يمكن للمستخدمين تعديل طلباتهم فقط" ON public.orders
  FOR UPDATE
  TO authenticated
  USING (auth.uid() = user_id);

-- سياسة تتيح للمسؤولين قراءة جميع الطلبات
CREATE POLICY "المسؤولون يمكنهم قراءة جميع الطلبات" ON public.orders
  FOR SELECT
  TO authenticated
  USING (true);
```

السياسات المطبقة على جدول `order_items`:

```sql
-- سياسة تتيح للمستخدمين المصادق عليهم إنشاء عناصر الطلبات
CREATE POLICY "يمكن للمستخدمين المصادق عليهم إنشاء عناصر الطلبات" ON public.order_items
  FOR INSERT
  TO authenticated
  WITH CHECK (true);

-- سياسة تتيح للمستخدمين قراءة عناصر طلباتهم فقط
CREATE POLICY "يمكن للمستخدمين قراءة عناصر طلباتهم فقط" ON public.order_items
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM orders 
      WHERE orders.id = order_items.order_id 
      AND orders.user_id = auth.uid()
    )
  );

-- سياسة تتيح للمستخدمين تعديل عناصر طلباتهم فقط
CREATE POLICY "يمكن للمستخدمين تعديل عناصر طلباتهم فقط" ON public.order_items
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM orders 
      WHERE orders.id = order_items.order_id 
      AND orders.user_id = auth.uid()
    )
  );
```

## تطبيق السياسات يدوياً من لوحة تحكم Supabase

يمكنك أيضاً تطبيق السياسات يدوياً من خلال واجهة Supabase:

1. قم بتسجيل الدخول إلى لوحة تحكم Supabase
2. انتقل إلى قسم Authentication > Policies
3. حدد الجدول `orders` من القائمة
4. انقر على زر "New Policy"
5. اختر الإذن المناسب (مثلاً Allow inserts) واملأ نموذج السياسة بناءً على السياسات المذكورة أعلاه
6. كرر العملية لجدول `order_items`

## في حالة استمرار المشكلة

إذا استمرت المشكلة بعد تطبيق الحلول المذكورة أعلاه، يرجى التحقق من الأتي:

1. التأكد من أن المستخدم مسجل الدخول قبل محاولة إنشاء الطلب
2. التأكد من تفعيل RLS على الجداول من خلال لوحة تحكم Supabase
3. تجربة الطريقة المحسنة `createOrderEnhanced` التي تستخدم طريقة مباشرة وطريقة RPC معاً
4. التأكد من أن المستخدم لديه صلاحيات كافية في قاعدة البيانات
5. استخدام دالة RPC المساعدة `create_order_with_items` إذا كانت الطرق الأخرى غير ناجحة

## ملاحظة هامة

ننصح بتطبيق سياسات RLS المناسبة (الحل الأول) لأنها الطريقة الأكثر أماناً واستقراراً لإدارة الوصول إلى بيانات الطلبات. الحلول الأخرى مقدمة كحلول بديلة سريعة فقط. 