# ملخص إصلاح مشكلة RLS للمسؤولين

تم إنشاء عدة ملفات لإصلاح مشكلة سياسات RLS التي تمنع المستخدمين المسؤولين من الوصول إلى لوحة التحكم والمحتوى الإداري:

## 1. ملف `supabase/fix-admin-rls.sql`

هذا الملف يحتوي على جميع التعديلات المطلوبة لسياسات RLS للسماح للمستخدمين المسؤولين بتجاوز قيود الأمان. يتضمن:

- إنشاء وظيفة `auth.is_admin()` للتحقق من صلاحيات المسؤول.
- حذف وإعادة إنشاء سياسات RLS للمنتجات والفئات والإعدادات والطلبات وعناصر الطلبات.

## 2. ملف `supabase/fix-admin-function.sql`

هذا الملف يحتوي فقط على وظيفة `auth.is_admin()` التي تتحقق من صلاحيات المسؤول. يمكن تنفيذ هذا الملف أولاً إذا كنت ترغب في تطبيق التغييرات بشكل تدريجي.

## 3. ملف `fix-admin-rls.js`

هذا سكريبت Node.js يقوم بقراءة ملف SQL وتنفيذه في قاعدة البيانات. ملاحظة: قد تواجه مشاكل في الاتصال بـ Supabase عند تنفيذ هذا السكريبت محلياً.

## 4. ملف `fix-admin-rls.bat`

ملف دفعة لتشغيل سكريبت `fix-admin-rls.js` في نظام Windows.

## 5. ملف `supabase/README-fix-admin-rls.md`

دليل مفصل يشرح المشكلة والحلول وكيفية تطبيق الإصلاحات في بيئة Supabase.

## طريقة تطبيق الإصلاح

الطريقة المفضلة لتطبيق الإصلاح هي:

1. نسخ محتوى ملف `supabase/fix-admin-rls.sql` أو `supabase/fix-admin-function.sql` (للتطبيق التدريجي).
2. الانتقال إلى واجهة SQL في Supabase.
3. لصق الكود في محرر SQL وتنفيذه.

## اختبار الإصلاح

بعد تطبيق الإصلاح، يجب أن يتمكن المستخدمون المسؤولون من:

1. الانتقال إلى لوحة التحكم بالضغط على "لوحة التحكم" في القائمة.
2. إدارة المنتجات والفئات والإعدادات.
3. الوصول إلى صفحة المحادثات من خلال الضغط على "المحادثات" في القائمة.
4. عرض وإدارة جميع الطلبات بغض النظر عن المستخدم الذي أنشأها.

## ملاحظات هامة

1. تحقق من أن جدول `users` الخاص بك يحتوي على حقل `is_admin` من نوع boolean.
2. إذا كان لديك جداول أخرى مع سياسات RLS، قد تحتاج إلى تعديل سياساتها بنفس الطريقة.
3. قد تحتاج إلى تسجيل الخروج وإعادة تسجيل الدخول من حساب المسؤول بعد تطبيق الإصلاحات لكي تأخذ التغييرات مفعولها. 